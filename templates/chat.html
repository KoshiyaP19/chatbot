<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Healthcare Chatbot</title>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #f0f8ff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .container {
            max-width: 900px;
            min-height: 90vh;
            margin: 40px auto;
            padding: 30px;
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .chat-box h2 {
            text-align: center;
            color: #00796b;
            margin-bottom: 20px;
        }

        .chat-history {
            height: 400px;
            overflow-y: auto;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-bottom: 20px;
            background-color: #e8f5e9;
        }

        .chat-history p {
            margin: 8px 0;
            line-height: 1.6;
        }

        form {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        button {
            padding: 10px 16px;
            border-radius: 8px;
            background-color: #00796b;
            color: white;
            border: none;
            cursor: pointer;
        }

        .mic-button {
            padding: 10px;
            background-color: #0288d1;
        }

        .extra-actions {
            margin-top: 15px;
        }

        a {
            display: inline-block;
            margin-top: 15px;
            color: #00796b;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="chat-box">
        <h2>Healthcare Chatbot</h2>

        <div class="chat-history" id="chat-history">
            {% for speaker, msg in chat_history %}
                <p><strong>{{ speaker }}:</strong> {{ msg|safe }}</p>
                {% if speaker == 'Bot' %}
                    <script>speakText(`{{ msg|safe }}`);</script>
                {% endif %}
            {% endfor %}
        </div>

        <form method="POST" id="chat-form">
            <input type="hidden" name="step" value="{{ step }}">
            <input type="text" name="message" id="message" placeholder="Enter your message..." required>
            <button type="submit">Send</button>
            <button type="button" class="mic-button" onclick="startVoiceInput()">üéôÔ∏è</button>
        </form>

        <div class="extra-actions">
            <button type="button" onclick="getLocationAndSend()">Find Nearby Hospitals</button>
            <div id="hospital-list" style="margin-top: 15px;"></div>
        </div>

        <a href="/history">View History</a> |
        <a href="/logout">Logout</a>
    </div>
</div>

<script>
// Location fetching function
function getLocationAndSend() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            fetch('/find_hospitals', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ latitude: lat, longitude: lon })
            })
            .then(response => response.json())
            .then(data => {
                let result = "<br><strong>Nearby Hospitals:</strong><ul>";
                if (Array.isArray(data)) {
    data.forEach(hospital => {
        result += `<li>${hospital.name}</li>`;
    });
} else if (data.hospitals && Array.isArray(data.hospitals)) {
    data.hospitals.forEach(hospital => {
        result += `<li>${hospital.name}</li>`;
    });
} else {
    result += "<li>No hospitals found or unexpected response.</li>";
}
                result += "</ul>";
                document.getElementById("chat-history").innerHTML += result;
                speakText("Here are some nearby hospitals.");
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Error fetching hospital data");
            });
        }, function () {
            alert("Geolocation failed. Please allow location access.");
        });
    } else {
        alert("Geolocation is not supported by this browser.");
    }
}

// üéôÔ∏è Voice Input
function startVoiceInput() {
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'en-US';
    recognition.interimResults = false;

    recognition.start();

    recognition.onresult = function (event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById("message").value = transcript;
    };

    recognition.onerror = function (event) {
        console.error("Speech recognition error:", event.error);
        alert("Voice input failed. Try again.");
    };
}

// üîä Text-to-Speech
function speakText(text) {
    const synth = window.speechSynthesis;
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US';
    synth.speak(utterance);
}
</script>

</body>
</html>
